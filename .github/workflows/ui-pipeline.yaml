name: Todo Fronted Pipeline

on:
    push:
        branches:
            - s3-production
        paths:
            - .github/**
            - docker/**
            - nginx/nginx.conf
            - public/**
            - src/**
            - package.json

jobs:
    build-and-deploy:
        name: Build and Deploy to AWS S3
        runs-on: ubuntu-latest
        steps:
          
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - name: Instal Node.js
              uses: actions/setup-node@v4
              with:
                node-version: 20

            - name: Instal dependencies & Build
              run: |
               VITE_APP_API_URL=${{secrets.API_URL}} npm install \ 
               && npm run build --prod

            - name: Configure AWS credentials
              env: 
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                AWS_REGION: ${{ secrets.AWS_REGION }}
              run: |
                    mkdir -p ~/.aws
                    echo "[default]" > ~/.aws/credentials
                    echo "aws_access_key_id = $AWS_ACCESS_KEY_ID" >> ~/.aws/credentials
                    echo "aws_secret_access_key = $AWS_SECRET_ACCESS_KEY" >> ~/.aws/credentials
                    echo "[default]" > ~/.aws/config
                    echo "region = $AWS_REGION" >> ~/.aws/config

            - name: Sync to S3 
              env: 
                AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
              run: aws s3 sync dist/ s3://$AWS_S3_BUCKET --delete

            - name: Cleanup AWS credentials
              if: always()
              run: |
                rm -f ~/.aws/credentials
                rm -f ~/.aws/config

            

                 

    
